$(function(){$(document).on("click","#seRemoveUpdateBtn",function(){const e=$("#fileList");window._lastTrackListData&&s(e,window._lastTrackListData)}),$(document).on("change","#repeatNotationCheckbox",function(){const e=this.checked?"withRepeatNotation":"none";window._repeatNotation=e;const t=$("#fileList");window._lastTrackListData&&s(t,window._lastTrackListData)}),$(document).on("input","#repeatThreshold",function(){const e=$("#fileList");window._lastTrackListData&&s(e,window._lastTrackListData)}),$(".numbering-row, .ext-row, .repeat-row, .se-remove-row").hide(),$("#toggleOptions").on("click",function(){$(".numbering-row, .ext-row, .repeat-row, .se-remove-row").each(function(){$(this).slideToggle(300)})}),$(document).on("click","#copyTs",function(){const e=$("#fileList li:not(.header)");if(0===e.length)return void alert("コピーするタイムスタンプがありません");const t=o(),n=[];e.each(function(e){const a=$(this).find(".ts").text(),i=$(this).find(".name").text();"head"===t?n.push(`${e+1} ${a} ${i}`):"beforeName"===t?n.push(`${a} ${e+1} ${i}`):n.push(`${a} ${i}`)}),navigator.clipboard.writeText(n.join("\n")).then(()=>{alert("タイムスタンプをコピーしました")})}),$(document).on("change",'input[name="extOption"]',function(){const e=$("#fileList");window._lastTrackListData&&s(e,window._lastTrackListData)});const e=$("#fileInput");function t(e){const t=Object.keys(e.files).find(e=>e.endsWith("timeline.wesproj"));t?e.files[t].async("string").then(n):alert("timeline.wesproj ファイルがzip内に見つかりません")}function n(e){const t=$("#fileList");t.empty();const n=o(),s=window._repeatNotation||"none";t.append(l(n));try{const o=JSON.parse(e),l=[];if(r(o,l),l.length>0){l.sort((e,t)=>{const n=Number(e.tlBegin),a=Number(t.tlBegin);return isNaN(n)||isNaN(a)?0:n-a}),window._lastTrackListData=l;let e=a(l,s),o=0;e.forEach(e=>{t.append(i(e,o,n,s)),o+=e.repeatCount})}else t.append("<li>filenameとtlBeginが見つかりませんでした。</li>")}catch(e){t.append("<li>JSONのパースに失敗しました。</li>")}}function a(e,t){if("withRepeatNotation"===t){const t=Number($("#repeatThreshold").val())||10;let n=!1;return e.map((e,a)=>a+1<t?{...e,isRepeat:!1,isVisible:!0}:n?{...e,isRepeat:!0,isVisible:!1}:(n=!0,{...e,isRepeat:!0,isVisible:!0}))}return e.map(e=>({...e,isRepeat:!1,isVisible:!0}))}function i(e,t,n,a){const i=document.createElement("li");i.classList.add("data-row");const o=document.createElement("span");o.className="num";const s=document.createElement("span");s.className="ts";const l=document.createElement("span");l.className="name",o.textContent=t+1,s.textContent=function(e){const t=Number(e);if(isNaN(t))return e;let n=Math.floor(t/1e7);const a=Math.floor(n/3600),i=Math.floor(n%3600/60),o=n%60;return`${a.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}(e.tlBegin);let r="string"!=typeof(c=e.filename)?c:c.split(/[/\\]/).pop();var c;return"withRepeatNotation"===a&&e.isRepeat&&(r="Repeat"),l.textContent=r,i.dataset.filename=e.filename,"head"===n?i.append(o,s,l):"beforeName"===n?i.append(s,o,l):i.append(s,l),i}function o(){const e=document.querySelector('input[name="numbering"]:checked');return e?e.value:"none"}function s(e,t){const n=o(),s=window._repeatNotation||"none",r=$('input[name="extOption"]:checked').val(),c=Number($("#seRemoveSecound").val())||0;e.empty(),e.append(l(n));let p=t.map(e=>{let t=e.filename.split(/[/\\]/).pop();return"none"===r&&(t=t.replace(/(\.mp3|\.wav)$/i,"")),{...e,filename:t}});c>0&&(p=p.filter(e=>{let t=9999;return"number"!=typeof e.duration||isNaN(e.duration)||(t=e.duration/1e7),t>c}));let u=a(p,s),d=0;u.forEach(t=>{!1!==t.isVisible&&(e.append(i(t,d,n,s)),d++)})}function l(e){return"head"===e?'<li class="header"><span class="num">No</span><span class="ts">開始時間</span><span class="name">ファイル名</span></li>':"beforeName"===e?'<li class="header"><span class="ts">開始時間</span><span class="num">No</span><span class="name">ファイル名</span></li>':'<li class="header"><span class="ts">開始時間</span><span class="name">ファイル名</span></li>'}function r(e,t){if(null==e||"object"!=typeof e)return;if("filename"in e&&"tlBegin"in e&&"string"==typeof e.filename&&(e.filename.toLowerCase().endsWith(".mp3")||e.filename.toLowerCase().endsWith(".wav"))){let n=null;"tlEnd"in e&&void 0!==e.tlEnd&&(n=Number(e.tlEnd)-Number(e.tlBegin)),t.push({filename:e.filename,tlBegin:e.tlBegin,duration:n})}for(const n in e)r(e[n],t)}0!==e.length&&(e.on("change",function(e){const n=e.target.files[0];n&&(n.name.endsWith(".wfp")?function(e){const n=new FileReader;n.onload=function(e){JSZip.loadAsync(e.target.result).then(t)},n.readAsArrayBuffer(e)}(n):alert("WFPファイルを選択してください"))}),$(document).on("change",'input[name="numbering"]',function(){const e=$("#fileList");window._lastTrackListData&&s(e,window._lastTrackListData)}))});