$(function(){$(".numbering-row, .ext-row").hide(),$("#toggleOptions").on("click",function(){$(".numbering-row, .ext-row").each(function(){$(this).slideToggle(300)})}),$(document).on("click","#copyTs",function(){const e=$("#fileList li:not(.header)");if(0===e.length)return void alert("コピーするタイムスタンプがありません");const n=i(),t=[];e.each(function(e){const a=$(this).find(".ts").text(),i=$(this).find(".name").text();"head"===n?t.push(`${e+1} ${a} ${i}`):"beforeName"===n?t.push(`${a} ${e+1} ${i}`):t.push(`${a} ${i}`)}),navigator.clipboard.writeText(t.join("\n")).then(()=>{alert("タイムスタンプをコピーしました")})}),$(document).on("change",'input[name="extOption"]',function(){const e=$('input[name="extOption"]:checked').val();$("#fileList").children("li").each(function(){const n=$(this);let t=n.data("filename");t&&(t=t.split(/[/\\]/).pop(),"none"===e&&(t=t.replace(/(\.mp3|\.wav)$/i,"")),n.find(".name").text(t))})});const e=$("#fileInput");function n(e){const n=Object.keys(e.files).find(e=>e.endsWith("timeline.wesproj"));n?e.files[n].async("string").then(t):alert("timeline.wesproj ファイルがzip内に見つかりません")}function t(e){const n=$("#fileList");n.empty();const t=i();n.append(s(t));try{const i=JSON.parse(e),s=[];o(i,s),s.length>0?(s.sort((e,n)=>{const t=Number(e.tlBegin),a=Number(n.tlBegin);return isNaN(t)||isNaN(a)?0:t-a}),s.forEach((e,i)=>{n.append(a(e,i,t))})):n.append("<li>filenameとtlBeginが見つかりませんでした。</li>")}catch(e){n.append("<li>JSONのパースに失敗しました。</li>")}}function a(e,n,t){const a=document.createElement("li");a.classList.add("data-row");const i=document.createElement("span");i.className="num";const s=document.createElement("span");s.className="ts";const o=document.createElement("span");var c;return o.className="name",i.textContent=n+1,s.textContent=function(e){const n=Number(e);if(isNaN(n))return e;let t=Math.floor(n/1e7);const a=Math.floor(t/3600),i=Math.floor(t%3600/60),s=t%60;return`${a.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}(e.tlBegin),o.textContent="string"!=typeof(c=e.filename)?c:c.split(/[/\\]/).pop(),a.dataset.filename=e.filename,"head"===t?a.append(i,s,o):"beforeName"===t?a.append(s,i,o):a.append(s,o),a}function i(){const e=document.querySelector('input[name="numbering"]:checked');return e?e.value:"none"}function s(e){return"head"===e?'<li class="header"><span class="num">No</span><span class="ts">開始時間</span><span class="name">ファイル名</span></li>':"beforeName"===e?'<li class="header"><span class="ts">開始時間</span><span class="num">No</span><span class="name">ファイル名</span></li>':'<li class="header"><span class="ts">開始時間</span><span class="name">ファイル名</span></li>'}function o(e,n){if(null==e||"object"!=typeof e)return;"filename"in e&&"tlBegin"in e&&"string"==typeof e.filename&&(e.filename.toLowerCase().endsWith(".mp3")||e.filename.toLowerCase().endsWith(".wav"))&&n.push({filename:e.filename,tlBegin:e.tlBegin});for(const t in e)o(e[t],n)}0!==e.length&&(e.on("change",function(e){const t=e.target.files[0];t&&(t.name.endsWith(".wfp")?function(e){const t=new FileReader;t.onload=function(e){JSZip.loadAsync(e.target.result).then(n)},t.readAsArrayBuffer(e)}(t):alert("WFPファイルを選択してください"))}),$(document).on("change",'input[name="numbering"]',function(){const e=$("#fileList"),n=$('input[name="extOption"]:checked').val(),t=e.children("li:not(.header)").toArray().map(e=>{let t=$(e).data("filename")||$(e).find(".name").text();return"none"===n&&"string"==typeof t&&(t=t.replace(/(\.mp3|\.wav)$/i,"")),{filename:t,tlBegin:$(e).find(".ts").text()}});e.empty();const o=i();e.append(s(o)),t.forEach((n,t)=>{e.append(a(n,t,o))})}))});